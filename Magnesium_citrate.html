<html lang="fa" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>مونوگراف سیترات منیزیم (USP)</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Vazirmatn:wght@400;500;700&display=swap" rel="stylesheet">
<script type="text/javascript" id="MathJax-script" async
src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
<script>
MathJax = {
tex: {
inlineMath: [['$', '$'], ['\\(', '\\)']],
displayMath: [['$$', '$$'], ['\\[', '\\]']]
},
svg: {
fontCache: 'global'
}
};
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- Include jsPDF library -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
    font-family: 'Vazirmatn', sans-serif;
    background-color: #f8f9fa;
    line-height: 1.6; /* Ensure good line spacing */
    word-spacing: normal; /* Default word spacing */
    letter-spacing: normal; /* Default letter spacing */
}
.tab-active { border-color: #3b82f6; color: #3b82f6; background-color: #eff6ff; }
.tab-inactive { border-color: transparent; color: #6b7280; }
.chart-container { position: relative; width: 100%; max-width: 800px; margin-left: auto; margin-right: auto; height: 350px; max-height: 40vh; }
.rtl-table th {
    text-align: right; /* Default for RTL table */
    vertical-align: top; /* Align headers to the top */
}
.rtl-table td {
    text-align: right; /* Default for RTL table */
    vertical-align: middle; /* Keep cell content vertically centered or adjust as needed */
}

/* Specific override for the results column in COA */
#coa-results-table-body td:last-child {
    text-align: left !important; /* Align results content to the left, important for override */
}

/* Specific override for the 'نتایج' header in COA */
#coa-content-to-pdf table thead th:last-child {
    text-align: left !important;
}

/* NEW: Ensure vertical alignment for all headers in COA table */
#coa-content-to-pdf table thead th {
    vertical-align: top !important;
}

.card {
    background-color: white;
    border-radius: 0.75rem;
    box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
    padding: 1.5rem;
    /* Ensure text properties are inherited correctly */
    line-height: inherit;
    word-spacing: inherit;
    letter-spacing: inherit;
    white-space: normal; /* Crucial for text flow */
}
/* Ensure LTR for specific numerical/unit strings within RTL context */
.ltr-text {
    direction: ltr;
    display: inline-block;
    unicode-bidi: isolate; /* Helps with isolation of LTR text in RTL flow */
}
/* Style for the math input fields to be text boxes */
.math-input {
    appearance: none; /* Removes default number input arrows */
    -moz-appearance: textfield; /* Firefox specific to remove arrows */
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    width: 100px; /* Adjust width as needed */
    text-align: left; /* Ensure numbers are left-aligned */
    direction: ltr; /* Ensure input direction is LTR */
}
.math-input-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 0.5rem;
}

/* Specific styles for the COA section to help with rendering */
#coa-content-to-pdf {
    direction: rtl; /* Explicitly set for the capture area */
    text-align: right; /* Default text alignment for RTL */
    /* Add some general padding/margin to ensure space around content */
    padding: 1.5rem;
}

/* Ensure all relevant text within COA inherits proper text settings */
#coa-content-to-pdf p,
#coa-content-to-pdf h1,
#coa-content-to-pdf h2,
#coa-content-to-pdf h3,
#coa-content-to-pdf th,
#coa-content-to-pdf td,
#coa-content-to-pdf label {
    font-family: 'Vazirmatn', sans-serif;
    line-height: 1.6; /* Consistent line height */
    word-spacing: normal;
    letter-spacing: normal;
    white-space: normal;
    /* Ensure sufficient vertical space for text */
    padding-top: 0.25rem;
    padding-bottom: 0.25rem;
}

/* Specific adjustments for input fields in the COA section */
#coa-content-to-pdf input[type="text"],
#coa-content-to-pdf input[type="date"] {
    /* Increase vertical padding to give more internal space */
    padding-top: 0.75rem; /* Increased from 0.5rem */
    padding-bottom: 0.75rem; /* Increased from 0.5rem */
    /* Ensure min-height to prevent squishing */
    min-height: 2.8rem; /* A reasonable minimum height */
    box-sizing: border-box; /* Include padding in the element's total width and height */
}

/* Adjustments for the input labels in the COA info section */
.grid.grid-cols-1.md\:grid-cols-2.gap-4.mb-6.text-gray-700.text-sm .flex.items-center.gap-2 {
    /* Ensure flex items distribute space correctly */
    align-items: flex-start; /* Align labels and inputs at the top of their row */
}

/* Adjustments for the signature inputs */
.grid.grid-cols-1.md\:grid-cols-3.gap-4.mb-6.text-gray-700.text-sm .flex.flex-col.items-center {
    /* Ensure enough space for the label and input field */
    min-height: 5rem; /* Give adequate height for both label and input */
    justify-content: flex-start; /* Align content to the top */
}
.grid.grid-cols-1.md\:grid-cols-3.gap-4.mb-6.text-gray-700.text-sm input[type="text"] {
    min-height: 2.8rem; /* Consistent height for signature inputs */
}

/* For table cells, add more padding to avoid text touching borders */
#coa-results-table-body td, #coa-results-table-body th {
    padding-top: 0.75rem; /* Increased vertical padding */
    padding-bottom: 0.75rem; /* Increased vertical padding */
    box-sizing: border-box; /* Ensure padding is included in element's total dimensions */
}

/* Remove internal borders from COA table cells */
#coa-content-to-pdf table th {
    border: none;
    padding-top: 1rem;       /* Increase vertical padding */
    padding-bottom: 1rem;
    font-size: 0.95rem;
    font-weight: 700;        /* Make it bold */
    background-color: #e5e7eb; /* Slightly darker gray than #f3f4f6 */
}

#coa-content-to-pdf table td {
    border: none;
}

</style>
</head>
<body class="bg-gray-50 text-gray-800">

<div class="container mx-auto p-4 md:p-8">

<header class="text-center mb-8">
<h1 class="text-3xl md:text-4xl font-bold text-gray-900">مونوگراف سیترات منیزیم (USP)</h1>
<p class="mt-2 text-lg text-gray-600">بررسی مشخصات دارویی طبق مونوگراف USP</p>
</header>

<nav class="mb-8 bg-white p-2 rounded-xl shadow-sm">
<div class="flex justify-center border-b border-gray-200 flex-wrap">
<button data-tab="definition" class="tab-button text-sm md:text-base font-medium py-3 px-4 md:px-6 border-b-2 tab-active">تعریف</button>
<button data-tab="identification" class="tab-button text-sm md:text-base font-medium py-3 px-4 md:px-6 border-b-2 tab-inactive">شناسایی</button>
<button data-tab="assay" class="tab-button text-sm md:text-base font-medium py-3 px-4 md:px-6 border-b-2 tab-inactive">سنجش</button>
<button data-tab="impurities" class="tab-button text-sm md:text-base font-medium py-3 px-4 md:px-6 border-b-2 tab-inactive">ناخالصی‌ها</button>
<button data-tab="specific-tests" class="tab-button text-sm md:text-base font-medium py-3 px-4 md:px-6 border-b-2 tab-inactive">آزمایشات خاص</button>
<button data-tab="packaging-storage" class="tab-button text-sm md:text-base font-medium py-3 px-4 md:px-6 border-b-2 tab-inactive">بسته‌بندی و نگهداری</button>
<button data-tab="coa" class="tab-button text-sm md:text-base font-medium py-3 px-4 md:px-6 border-b-2 tab-inactive">COA</button>
</div>
</nav>

<main>
<div id="definition" class="tab-content space-y-8">
<div class="card">
<h2 class="text-2xl font-bold mb-4 text-gray-800">تعریف سیترات منیزیم</h2>
<p class="text-gray-600 mb-6">این بخش شامل تعریف سیترات منیزیم و مقادیر مجاز منیزیم است.</p>
</div>
<div class="card">
<h3 class="text-xl font-bold mb-4">تعریف</h3>
<p class="text-gray-700 mb-4">سیترات منیزیم حاوی حداقل <span class="ltr-text">14.5%</span> و حداکثر <span class="ltr-text">16.4%</span> منیزیم (<span class="ltr-text">$Mg$</span>) است که بر اساس ماده خشک محاسبه می‌شود.</p>
<p class="text-gray-700 mt-4">فرمول شیمیایی: <span class="ltr-text">$C_{12}H_{10}Mg_{3}O_{14}$</span></p>
<p class="text-gray-700">وزن مولکولی: <span class="ltr-text">451.11</span></p>
</div>
</div>

<div id="identification" class="tab-content hidden space-y-8">
<div class="card">
<h2 class="text-2xl font-bold mb-4 text-gray-800">شناسایی</h2>
<p class="text-gray-600 mb-6">این بخش شامل معیارهای شناسایی سیترات منیزیم است.</p>
</div>
<div class="card">
<h3 class="text-xl font-bold mb-4">آزمایشات شناسایی</h3>
<ul class="space-y-3 list-disc list-inside text-gray-700">
<li><span class="font-bold">A. منیزیم (<a href="General chapters/〈191〉 IDENTIFICATION TESTS—GENERAL.pdf" class="text-blue-600 hover:underline" target="_blank">191</a>):</span>
<ul class="list-circle list-inside ml-5">
<li>نمونه: <span class="ltr-text">10 mg/mL</span></li>
<li>معیار پذیرش: الزامات را برآورده می‌کند.</li>
</ul>
</li>
<li><span class="font-bold">B. سیترات (<a href="General chapters/〈191〉 IDENTIFICATION TESTS—GENERAL.pdf" class="text-blue-600 hover:underline" target="_blank">191</a>):</span>
<ul class="list-circle list-inside ml-5">
<li>نمونه: <span class="ltr-text">80 mg/mL</span></li>
<li>معیار پذیرش: الزامات را برآورده می‌کند.</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="assay" class="tab-content hidden space-y-8">
<div class="card">
<h2 class="text-2xl font-bold mb-4 text-gray-800">سنجش منیزیم</h2>
<p class="text-gray-600 mb-6">این بخش جزئیات روش سنجش برای تعیین مقدار منیزیم (<span class="ltr-text">$Mg$</span>) در سیترات منیزیم را توضیح می‌دهد.</p>
</div>
<div class="card">
<h3 class="text-xl font-bold mb-4">روش کار:</h3>
<p class="text-gray-700 mb-4">نمونه: <span class="ltr-text">400 mg</span></p>
<p class="text-gray-700 mb-4">تجزیه و تحلیل: نمونه را در <span class="ltr-text">50 mL</span> آب حل کنید. <span class="ltr-text">20 mL</span> از بافر آمونیاک-آمونیوم کلرید <span class="ltr-text">TS</span> و <span class="ltr-text">0.1 mL</span> از اریوکروم بلک <span class="ltr-text">TS</span> اضافه کنید. با <span class="ltr-text">0.05 M</span> تیترانت ادتات دی‌سدیم <span class="ltr-text">VS</span> تا نقطه پایانی آبی تیتر کنید. تعیین بلانک را انجام دهید (به تیترسنجی (<a href="General chapters/〈541〉 TITRIMETRY.pdf" class="text-blue-600 hover:underline" target="_blank">541</a>) مراجعه کنید) و هرگونه تصحیح لازم را انجام دهید. از حجم <span class="ltr-text">0.05 M</span> تیترانت ادتات دی‌سدیم مصرفی، حجمی از <span class="ltr-text">0.05 M</span> تیترانت ادتات دی‌سدیم را که مربوط به مقدار کلسیم در بخش سیترات منیزیم گرفته شده است، بر اساس مقدار کلسیم یافت شده در آزمایش حد کلسیم, کسر کنید. هر <span class="ltr-text">mg</span> کلسیم معادل <span class="ltr-text">0.25 mL</span> از <span class="ltr-text">0.05 M</span> ادتات دی‌سدیم است. تفاوت، حجم <span class="ltr-text">0.05 M</span> ادتات دی‌سدیم مصرفی توسط منیزیم است. هر <span class="ltr-text">mL</span> از <span class="ltr-text">0.05 M</span> ادتات دی‌سدیم معادل <span class="ltr-text">1.215 mg</span> منیزیم (<span class="ltr-text">$Mg$</span>) است.</p>

<!-- The entire "محاسبه درصد منیزیم" section has been removed -->
</div>
</div>

<div id="impurities" class="tab-content hidden space-y-8">
<div class="card">
<h2 class="text-2xl font-bold mb-4 text-gray-800">ناخالصی‌ها</h2>
<p class="text-gray-600 mb-6">این بخش شامل آزمایشات مربوط به ناخالصی‌ها در سیترات منیزیم است.</p>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
<div class="card">
<h3 class="text-xl font-bold mb-4">کلرید و سولفات</h3>
<ul class="space-y-3 list-disc list-inside text-gray-700">
<li><span class="font-bold">کلرید (<a href="General chapters/〈221〉 CHLORIDE AND SULFATE.pdf" class="text-blue-600 hover:underline" target="_blank">221</a>):</span>
<ul class="list-circle list-inside ml-5">
<li>نمونه: <span class="ltr-text">300 mg</span></li>
<li>معیار پذیرش: بیش از <span class="ltr-text">0.20 mL</span> از <span class="ltr-text">0.020 N</span> اسید کلریدریک (<span class="ltr-text">0.05%</span>) کلرید نشان نمی‌دهد.</li>
</ul>
</li>
<li><span class="font-bold">سولفات (<a href="General chapters/〈221〉 CHLORIDE AND SULFATE.pdf" class="text-blue-600 hover:underline" target="_blank">221</a>):</span>
<ul class="list-circle list-inside ml-5">
<li>نم نمونه: <span class="ltr-text">100 mg</span></li>
<li>معیار پذیرش: بیش از <span class="ltr-text">0.20 mL</span> از <span class="ltr-text">0.020 N</span> اسید سولفوریک (<span class="ltr-text">0.2%</span>) سولفات نشان نمی‌دهد.</li>
</ul>
</li>
</ul>
</div>
<div class="card">
<h3 class="text-xl font-bold mb-4">آرسنیک (<a href="General chapters/〈211〉 ARSENIC.pdf" class="text-blue-600 hover:underline" target="_blank">211</a>)</h3>
<p class="text-gray-700">معیار پذیرش: <span class="ltr-text">NMT 3 ppm</span></p>
</div>
<div class="card">
<h3 class="text-xl font-bold mb-4">آهن (<a href="General chapters/〈241〉 IRON.pdf" class="text-blue-600 hover:underline" target="_blank">241</a>)</h3>
<ul class="space-y-3 list-disc list-inside text-gray-700">
<li>تهیه آزمایش: <span class="ltr-text">50 mg</span> را با <span class="ltr-text">5 mL</span> از <span class="ltr-text">2 N</span> اسید نیتریک به مدت <span class="ltr-text">1 min</span> بجوشانید. خنک کنید، با آب تا <span class="ltr-text">45 mL</span> رقیق کنید و <span class="ltr-text">2 mL</span> اسید کلریدریک اضافه کنید.</li>
<li>معیار پذیرش: <span class="ltr-text">NMT 200 ppm</span></li>
</ul>
</div>
<div class="card">
<h3 class="text-xl font-bold mb-4">حد کلسیم</h3>
<p class="text-gray-700 mb-4">تعیین غلظت <span class="ltr-text">C</span>، بر حسب <span class="ltr-text">$\mu g/mL$</span> کلسیم در محلول نمونه با استفاده از نمودار کالیبراسیون. درصد کلسیم در بخش سیترات منیزیم گرفته شده محاسبه می‌شود:</p>
<p class="font-mono text-center text-lg mb-4">$$Result=(V/W\times C\times F)\times100$$</p>
<ul class="list-disc list-inside text-gray-700 space-y-1 mb-6">
<li>$V$ = حجم محلول نمونه (<span class="ltr-text">mL</span>)</li>
<li>$W$ = وزن سیترات منیزیم گرفته شده (<span class="ltr-text">mg</span>)</li>
<li>$C$ = غلظت کلسیم در محلول نمونه (<span class="ltr-text">$\mu g/mL$</span>)</li>
<li>$F$ = تبدیل از <span class="ltr-text">$\mu g/mL$</span> به <span class="ltr-text">mg/mL</span>، <span class="ltr-text">0.001</span></li>
</ul>
<div class="flex flex-col gap-2 justify-center items-center text-gray-700 text-sm">
<div class="math-input-group">
<label for="calciumV">\(V\):</label>
<input class="math-input" id="calciumV" type="number" value="">
</div>
<div class="math-input-group">
<label for="calciumW">\(W\):</label>
<input class="math-input" id="calciumW" type="number" value="">
</div>
<div class="math-input-group">
<label for="calciumC">\(C\):</label>
<input class="math-input" id="calciumC" type="number" value="">
</div>
<div class="math-input-group">
<label for="calciumF">\(F\):</label>
<input class="math-input" id="calciumF" type="number" value="0.001" readonly>
</div>
<button onclick="calculateLimitOfCalcium()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mt-4">محاسبه حد کلسیم</button>
</div>
<div class="text-center mt-4">
<p class="text-gray-700">نتیجه کلسیم: <span id="calciumResult" class="font-bold text-blue-700">--</span>%</p>
</div>
<p class="text-gray-700 mt-4">معیار پذیرش: <span class="ltr-text">NMT 1.0%</span> بر اساس ماده خشک.</p>
</div>
</div>
</div>

<div id="specific-tests" class="tab-content hidden space-y-8">
<div class="card">
<h2 class="text-2xl font-bold mb-4 text-gray-800">آزمایشات خاص</h2>
<p class="text-gray-600 mb-6">این بخش شامل آزمایشات خاصی است که برای اطمینان از کیفیت و خلوص سیترات منیزیم انجام می‌شود، از جمله بررسی <span class="ltr-text">pH</span> و افت وزن در اثر خشک شدن.</p>
</div>
<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
<div class="card">
<h3 class="text-xl font-bold mb-4">pH (<a href="General chapters/〈791〉 pH.pdf" class="text-blue-600 hover:underline" target="_blank">791</a>)</h3>
<p class="text-gray-700">بین <span class="ltr-text">5.0</span> و <span class="ltr-text">9.0</span>، در سوسپانسیون <span class="ltr-text">(50 mg/mL)</span>.</p>
</div>
<div class="card">
<h3 class="text-xl font-bold mb-4">افت وزن در اثر خشک شدن (LOD) (<a href="General chapters/〈731〉 LOSS ON DRYING.pdf" class="text-blue-600 hover:underline" target="_blank">731</a>)</h3>
<p class="text-gray-700 mb-4">یک گرم را در آون همرفتی مکانیکی در دمای <span class="ltr-text">135°</span> به مدت <span class="ltr-text">16 h</span> خشک کنید، سپس تا وزن ثابت: بیش از <span class="ltr-text">29%</span> از وزن خود را از دست نمی‌دهد، مگر اینکه به عنوان بدون آب برچسب‌گذاری شده باشد، در این صورت بیش از <span class="ltr-text">2.0%</span> از وزن خود را از دست نمی‌دهد.</p>
<h4 class="font-bold text-gray-800 mt-6 mb-2">محاسبه افت وزن در اثر خشک شدن (LOD):</h4>
<p class="font-mono text-center text-lg mb-4">$$LOD = \frac{(W_{initial} - W_{final})}{W_{initial}} \times 100$$</p>
<ul class="list-disc list-inside text-gray-700 space-y-1 mb-6">
<li>$W_{initial}$ = وزن اولیه نمونه (<span class="ltr-text">g</span>)</li>
<li>$W_{final}$ = وزن نهایی نمونه پس از خشک شدن (<span class="ltr-text">g</span>)</li>
</ul>
<div class="flex flex-col gap-2 justify-center items-center text-gray-700 text-sm">
<div class="math-input-group">
<label for="lodInitialWeight">\(W_{initial}\):</label>
<input class="math-input" id="lodInitialWeight" type="number" value="">
</div>
<div class="math-input-group">
<label for="lodFinalWeight">\(W_{final}\):</label>
<input class="math-input" id="lodFinalWeight" type="number" value="">
</div>
<button onclick="calculateLOD()" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded mt-4">محاسبه LOD</button>
</div>
<div class="text-center mt-4">
<p class="text-gray-700">نتیجه LOD: <span id="lodResult" class="font-bold text-blue-700">--</span>%</p>
</div>
</div>
</div>
</div>

<div id="packaging-storage" class="tab-content hidden space-y-8">
<div class="card">
<h2 class="text-2xl font-bold mb-4 text-gray-800">بسته‌بندی و نگهداری</h2>
<p class="text-gray-600 mb-6">این بخش شامل اطلاعات مهم در مورد نحوه بسته‌بندی و نگهداری سیترات منیزیم است.</p>
</div>
<div class="card">
<h3 class="text-xl font-bold mb-4">بسته‌بندی و نگهداری</h3>
<ul class="space-y-3 list-disc list-inside text-gray-700">
<li>در ظروف محکم نگهداری شود.</li>
</ul>
<h3 class="text-xl font-bold mb-4 mt-6">برچسب‌گذاری</h3>
<ul class="space-y-3 list-disc list-inside text-gray-700">
<li>سیترات منیزیم که در آزمایش افت وزن در اثر خشک شدن بیش از <span class="ltr-text">2.0%</span> از وزن خود را از دست نمی‌دهد، ممکن است به عنوان سیترات منیزیم بدون آب برچسب‌گذاری شود.</li>
</ul>
</div>
</div>

<div id="coa" class="tab-content hidden space-y-8">
<div class="card">
<h2 class="text-2xl font-bold mb-4 text-gray-800">گواهی تجزیه و تحلیل (COA)</h2>
<p class="text-gray-600 mb-6">این بخش نتایج محاسبات انجام شده در سایر بخش‌های مونوگراف را خلاصه می‌کند.</p>
</div>
<div class="card" id="coa-content-to-pdf">
<h3 class="text-xl font-bold mb-4">اطلاعات محصول</h3>
<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6 text-gray-700 text-sm">
<div class="flex items-center gap-2">
<label for="coaProductName" class="font-bold">نام محصول:</label>
<span id="coaProductNameDisplay" class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 text-gray-700">سیترات منیزیم</span>
</div>
<div class="flex items-center gap-2">
<label for="coaBatchNumber" class="font-bold">شماره بچ:</label>
<input type="text" id="coaBatchNumber" class="w-full p-2 border border-gray-300 rounded-md" value="">
</div>
<div class="flex items-center gap-2">
<label for="coaMfgDate" class="font-bold">تاریخ تولید:</label>
<input type="date" id="coaMfgDate" class="w-full p-2 border border-gray-300 rounded-md" value="">
</div>
<div class="flex items-center gap-2">
<label for="coaProductCode" class="font-bold">کد محصول:</label>
<input type="text" id="coaProductCode" class="w-full p-2 border border-gray-300 rounded-md" value="">
</div>
<div class="flex items-center gap-2">
<label for="coaRetestDate" class="font-bold">تاریخ آزمایش مجدد:</label>
<input type="date" id="coaRetestDate" class="w-full p-2 border border-gray-300 rounded-md" value="">
</div>
<div class="flex items-center gap-2">
<label for="coaAnalysisNumber" class="font-bold">شماره آنالیز:</label>
<input type="text" id="coaAnalysisNumber" class="w-full p-2 border border-gray-300 rounded-md" value="">
</div>
</div>

<h3 class="text-xl font-bold mb-4">نتایج آزمایش</h3>
<div class="overflow-x-auto mb-6">
<table class="min-w-full bg-white rtl-table border border-gray-200">
<thead class="bg-gray-100">
<tr>
<th class="py-3 px-4 font-bold text-sm text-gray-600 uppercase tracking-wider">آزمایش‌ها</th>
<th class="py-3 px-4 font-bold text-sm text-gray-600 uppercase tracking-wider">مشخصات (USP)</th>
<th class="py-3 px-4 font-bold text-sm text-gray-600 uppercase tracking-wider">نتایج</th>
</tr>
</thead>
<tbody id="coa-results-table-body">
</tbody>
</table>
</div>

<h3 class="text-xl font-bold mb-4">امضاها</h3>
<div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6 text-gray-700 text-sm">
<div class="flex flex-col items-center">
<label for="coaAnalyst" class="font-bold mb-1">آنالیزور:</label>
<input type="text" id="coaAnalyst" class="w-full p-2 border border-gray-300 rounded-md text-center" value="">
</div>
<div class="flex flex-col items-center">
<label for="coaSupervisor" class="font-bold mb-1">سرپرست آزمایشگاه QC:</label>
<input type="text" id="coaSupervisor" class="w-full p-2 border border-gray-300 rounded-md text-center" value="">
</div>
<div class="flex flex-col items-center">
<label for="coaQCManager" class="font-bold mb-1">مدیر QC:</label>
<input type="text" id="coaQCManager" class="w-full p-2 border border-gray-300 rounded-md text-center" value="">
</div>
</div>

<div class="flex justify-center">
<button onclick="exportCOAPDF()" class="bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded mt-4">ذخیره COA به صورت PDF</button>
</div>
</div>
</div>
</main>
</div>

<script>
// Object to store calculation results for COA
let calculationResults = {
    mgAssay: { label: 'سنجش منیزیم', value: '---', unit: '', status: 'static', spec: '14.5%-16.4%' }, // Changed to static
    chloride: { label: 'کلرید', value: '---', unit: '', status: 'static', spec: 'NMT 0.05%' },
    sulfate: { label: 'سولفات', value: '---', unit: '', status: 'static', spec: 'NMT 0.2%' },
    arsenic: { label: 'آرسنیک', value: '---', unit: '', status: 'static', spec: 'NMT 3 ppm' },
    iron: { label: 'آهن', value: '---', unit: '', status: 'static', spec: 'NMT 200 ppm' },
    limitOfCalcium: { label: 'حد کلسیم', value: '--', unit: '%', status: 'initial', spec: 'NMT 1.0%' },
    pH: { label: 'pH', value: '---', unit: '', status: 'static', spec: '5.0-9.0' },
    lod: { label: 'افت وزن در اثر خشک شدن (LOD)', value: '--', unit: '%', status: 'initial', spec: 'NMT 29% (NMT 2.0% for anhydrous)' },
};

// Function to update the COA tab content dynamically
function updateCOATab() {
    const coaResultsTableBody = document.getElementById('coa-results-table-body');
    if (!coaResultsTableBody) return; // Exit if COA table body not found

    coaResultsTableBody.innerHTML = ''; // Clear existing rows

    for (const key in calculationResults) {
        if (calculationResults.hasOwnProperty(key)) {
            const resultData = calculationResults[key];
            const tableRow = document.createElement('tr');
            let valueClass = 'text-blue-700';

            if (resultData.status === 'error') {
                valueClass = 'text-red-500';
            } else if (resultData.status === 'static') {
                valueClass = 'text-gray-700'; // For static "---" results
            }

            tableRow.innerHTML = `
                <td class="py-2 px-3">${resultData.label}</td>
                <td class="py-2 px-3 ltr-text">${resultData.spec}</td>
                <td class="py-2 px-3 font-bold ${valueClass}" dir="ltr">
                    <span style="display: inline-block; width: 100%; text-align: left;">
                        ${resultData.value}${resultData.unit}
                    </span>
                </td>
            `;
            coaResultsTableBody.appendChild(tableRow);
        }
    }
}

// Helper function to update a specific calculation result and then the COA tab
function setCalculationResult(key, value, unit = '', status = 'calculated', spec = null) {
    calculationResults[key].value = value;
    calculationResults[key].unit = unit;
    calculationResults[key].status = status;
    if (spec !== null) {
        calculationResults[key].spec = spec;
    }
    updateCOATab(); // Update COA tab after any calculation
}

// Calculation function for Assay for Magnesium - REMOVED LOGIC
window.calculateMgAssay = function() {
    // No calculation logic here as per monograph
    const resultElement = document.getElementById('mgAssayResult');
    resultElement.textContent = "---"; // Or leave empty
    resultElement.classList.remove('text-red-500');
    resultElement.classList.add('text-gray-700');
    setCalculationResult('mgAssay', '---', '', 'static');
};

// Calculation function for Limit of Calcium
window.calculateLimitOfCalcium = function() {
    const V = parseFloat(document.getElementById('calciumV').value);
    const W = parseFloat(document.getElementById('calciumW').value);
    const C = parseFloat(document.getElementById('calciumC').value);
    const F = parseFloat(document.getElementById('calciumF').value); // Fixed at 0.001

    const resultElement = document.getElementById('calciumResult');

    if (isNaN(V) || isNaN(W) || isNaN(C) || isNaN(F)) {
        resultElement.textContent = "خطا: لطفاً تمام فیلدها را با اعداد معتبر پر کنید.";
        resultElement.classList.remove('text-blue-700');
        resultElement.classList.add('text-red-500');
        setCalculationResult('limitOfCalcium', 'خطا', '', 'error');
        return;
    }
    if (W === 0) {
        resultElement.textContent = "خطا: وزن سیترات منیزیم (W) نمی‌تواند صفر باشد.";
        resultElement.classList.remove('text-blue-700');
        resultElement.classList.add('text-red-500');
        setCalculationResult('limitOfCalcium', 'خطا', '', 'error');
        return;
    }

    const result = (V / W * C * F) * 100;
    resultElement.textContent = result.toFixed(2) + '%';
    resultElement.classList.remove('text-red-500');
    resultElement.classList.add('text-blue-700');

    setCalculationResult('limitOfCalcium', result.toFixed(2), '%', 'calculated', 'NMT 1.0%');
};

// Calculation function for Loss on Drying (LOD)
window.calculateLOD = function() {
    const initialWeight = parseFloat(document.getElementById('lodInitialWeight').value);
    const finalWeight = parseFloat(document.getElementById('lodFinalWeight').value);
    const resultElement = document.getElementById('lodResult');

    if (isNaN(initialWeight) || isNaN(finalWeight)) {
        resultElement.textContent = "خطا: لطفاً تمام فیلدها را با اعداد معتبر پر کنید.";
        resultElement.classList.remove('text-blue-700');
        resultElement.classList.add('text-red-500');
        setCalculationResult('lod', 'خطا', '', 'error');
        return;
    }
    if (initialWeight === 0) {
        resultElement.textContent = "خطا: وزن اولیه (W_initial) نمی‌تواند صفر باشد.";
        resultElement.classList.remove('text-blue-700');
        resultElement.classList.add('text-red-500');
        setCalculationResult('lod', 'خطا', '', 'error');
        return;
    }

    const result = ((initialWeight - finalWeight) / initialWeight) * 100;
    resultElement.textContent = result.toFixed(2) + '%';
    resultElement.classList.remove('text-red-500');
    resultElement.classList.add('text-blue-700');

    setCalculationResult('lod', result.toFixed(2), '%', 'calculated', 'NMT 29% (NMT 2.0% for anhydrous)');
};


// Function to export COA as a PDF
window.exportCOAPDF = function() {
    const element = document.getElementById('coa-content-to-pdf');
    const exportButton = element.querySelector('button'); // Get the specific button within the COA content

    // Hide the button before capturing
    if (exportButton) {
        exportButton.style.display = 'none';
    }

    document.fonts.ready.then(() => {
        html2canvas(element, {
            scale: 3, // Increased scale for higher resolution
            logging: true,
            useCORS: true, // Important if you have images from different origins
        }).then(function(canvas) {
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf; // Get jsPDF from the global window object
            const pdf = new jsPDF('p', 'mm', 'a4'); // 'p' for portrait, 'mm' for millimeters, 'a4' for A4 size

            const imgWidth = 210; // A4 width in mm
            const pageHeight = 297; // A4 height in mm
            const imgHeight = canvas.height * imgWidth / canvas.width;
            let heightLeft = imgHeight;

            let position = 0;

            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;

            while (heightLeft >= 0) {
                position = heightLeft - imgHeight;
                pdf.addPage();
                pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
                heightLeft -= pageHeight;
            }

            pdf.save(`COA_Magnesium_Citrate_${new Date().toISOString().slice(0, 10)}.pdf`);

        }).catch(error => {
            console.error("Error capturing screenshot or generating PDF:", error);
            alert("خطا در گرفتن اسکرین‌شات یا تولید PDF: " + error.message);
        }).finally(() => {
            // Show the button again after capture (whether successful or not)
            if (exportButton) {
                exportButton.style.display = ''; // Reset to default display
            }
        });
    }).catch(error => {
        console.error("Font loading error:", error);
        alert("خطا در بارگذاری فونت. ممکن است PDF به درستی نمایش داده نشود.");
        // Ensure button is shown even if font loading fails
        if (exportButton) {
            exportButton.style.display = '';
        }
    });
};


document.addEventListener('DOMContentLoaded', function () {
    // Tab navigation for main tabs
    const mainTabButtons = document.querySelectorAll('nav .tab-button');
    const mainTabContents = document.querySelectorAll('main > .tab-content');

    mainTabButtons.forEach(button => {
        button.addEventListener('click', function() {
            mainTabButtons.forEach(btn => {
                btn.classList.remove('tab-active');
                btn.classList.add('tab-inactive');
            });
            this.classList.add('tab-active');
            this.classList.remove('tab-inactive');

            mainTabContents.forEach(content => {
                content.classList.add('hidden');
            });
            document.getElementById(this.dataset.tab).classList.remove('hidden');

            // Re-run MathJax on the newly loaded content
            if (typeof MathJax !== 'undefined') {
                MathJax.typeset([document.getElementById(this.dataset.tab)]);
            }

            // If COA tab is clicked, update its content
            if (this.dataset.tab === 'coa') {
                updateCOATab(); // Refresh COA tab content
            }
        });
    });

    // Initial MathJax typesetting for the default visible tab (definition)
    if (typeof MathJax !== 'undefined') {
        MathJax.typeset([document.getElementById('definition')]);
    }

    // Initial update of COA tab content on page load
    updateCOATab();
});
</script>
</body>
</html>
